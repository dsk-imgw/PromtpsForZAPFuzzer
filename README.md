# LLM Prompts for ZAP (Zed Attack Proxy) Fuzzer

ZAProxy の Fuzzer 機能を使って LLM のセキュリティを検査するためのデータと、データを作成したり結果を整理したりするためのツール。結果に問題があるかどうかを自動判定する機能はなく、人間の目で結果を精査する必要がある。

## §1. スキャン

### §1-1. スキャンの実行

1. ZAP を起動する。
2. ブラウザやターミナルにプロキシー設定を行い、対象の URL にアクセスして、ZAP に HTTP 通信をキャプチャさせる。
3. 「サイト」ツリーから診断対象の URL を選択し、右クリックで「攻撃」→「Fuzzer の開始」を選択する。
4. 「Fuzz Locations」ウィンドウで置換する箇所をドラッグして選択する。JSON の値の場合、両端の " も含める。
5. 4.を実行すると、右画面の「Fuzz Locations:」の「追加」ボタンが押せるようになるので、押下する。
6. 「Payloads」ウィンドウで「追加」を押下する。
7. 「ペイロードを追加」ウィンドウで、タイプで「ファイル」を選択し、「参照」を押下してペイロード ファイルを選択する。
8. 「Payload Preview:」に表示されるペイロードの内容を確認（とりあえず何も表示されていない状態ではないことを確認）して、「追加」を押下する。
9. 「Payloads」ウィンドウで、8. で追加したファイルが一覧にあることを確認して、「OK」を押下する。
10. 最後に、「Payloads」ウィンドウ右下の「Start Fuzzer」を押下する。
11. 2.～10. を複数回（最低でも 3 回、最大 10 回）繰り返す。これは、LLM の回答は確率論的に生成されるため、同じリクエストを複数回送信すること回答のでランダム性による検知漏れを軽減するためである（送信回数については確立された値がないため、ベンダーやテスターの情報・個人の経験的な感触をもとに記載）。

### §1-2. 結果の確認とエクスポート

1. メイン ウィンドウの下部「Fuzzer」に進捗状況が表示されるので、「進行状況」が 100% になり、「Error:」の件数が 0 であることを確認する。
2. メイン ウィンドウの下部「Fuzzer」の全行を選択して、右クリックから「Add to Sites Tree & History」を選択する。
3. メイン ウィンドウの下部「履歴」を選択し、2. で選択した通信が追加されていることを確認する。そのうえで、追加された行を選択し、メニューの「エクスポート」→「Save Messages ...」を選択する。
4. ファイル名を指定して、「保存」する。
5. 1.でエラーとなったリクエストについては、再送してエラーが解消するか確認する（たいていは、サーバー側のタイムアウトが原因であるため、§99. のタイムアウト設定を見直す）。

### §1-3. 保存したメッセージファイルの加工（任意）

1. 上記 2. の 4. で保存したメッセージ ファイルを、以下のコマンドで加工する。```data/``` 配下に、Excel 形式に変換したファイル ```【「ランダム UUID」 or 「-p オプションで指定した接頭辞」】.xlsx``` と、リクエストごとのファイル群 ```【「ランダム UUID」 or 「-p オプションで指定した接頭辞」】-「通番」.txt``` が生成される。

```
python process_results.py [-p 付与するファイル接頭辞] 保存したメッセージファイル
```

## §2. ペイロードのメンテ

## §2-1. ペイロードのメンテナンスとフォーマット変換

1. ペイロードは、デイレクトリ ```payloads/en/raw/``` または ```payloads/ja/raw/``` に ```【ファイル名】.txt``` で配置する。書式は、ペイロードを 1 行 1 行記入する。```#``` で始まる行はコメントで、改行やタブなどの制御文字は ```\n``` や ```\t``` 等で記載する。```"``` などは ```\"``` のようにエスケープは不要。
2. JSON や URL エンコードしたものについては、```convert_payloads.py``` を実行することで、1. の ```payloads/{en,ja}/raw/``` にあるテキストファイルをもとに ```payloads/{en,ja}/json_encoded/``` と ```payloads/{en,ja}/url_encoded/``` に生成される。

## §2-2. ペイロードの日本語化

- 現時点（2024 年 9 月）時点では、ペイロードは英語であり、まともな日本語版ペイロードは存在しない。そのため、Google 翻訳等で英語から日本語に変換する。
- 日本語版のファイル名は英語版と一致させ、文字コードは UTF-8 とする。

## §99. その他

- ZAP での動作確認は、2.15.0 （Windows 版と Linux 版）で実施。
- Burp Suite の Intruder でも同じことができるはず。ただし、Pro 版（有料版）でないと、速度制限や結果保存不可の制約を受ける。
- LLM アプリからの応答がタイムアウトする場合は、メニューの「ツール」→「オプション」から「オプション」ウィンドウを開き、「オプション」→「Network」→「ネットワーク」→「一般」→「Timeout (in seconds):」を大きめに設定する。

